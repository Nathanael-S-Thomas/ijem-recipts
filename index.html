<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Receipt Generator</title>

  <!-- âœ… Firebase + html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    // ðŸ”‘ INSERT YOUR FIREBASE CONFIG HERE
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // âœ… Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // make available globally
    window.db = db;
    window.storage = storage;
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.updateDoc = updateDoc;
    window.ref = ref;
    window.uploadBytes = uploadBytes;
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      display: flex;
      gap: 30px;
    }
    form {
      width: 300px;
    }
    form input, form textarea, form button {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
    }
    .receipt {
      width: 700px;
      border: 2px solid black;
      padding: 20px;
    }
    .title {
      text-align: center;
      text-decoration: underline;
      margin-bottom: 20px;
      font-size: 20px;
      font-weight: bold;
    }
    .header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .details {
      width: 100%;
      border-collapse: collapse;
    }
    .details td {
      border: 1px solid black;
      padding: 8px;
    }
    .footer {
      margin-top: 20px;
    }
    .footer p {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <!-- âœ… Form -->
  <form>
    <input id="name" type="text" placeholder="Customer Name" required>
    <input id="payment" type="text" placeholder="Payment Method" required>
    <input id="amount" type="number" placeholder="Amount (â‚¹)" required>
    <textarea id="description" placeholder="Description"></textarea>
    <button type="button" id="previewBtn">Preview</button>
    <button type="button" id="printBtn">Print & Save</button>
  </form>

  <!-- âœ… Receipt Preview -->
  <div id="receiptPreview" class="receipt">
    <h2 class="title">RECEIPT</h2>

    <div class="header">
      <p><b>Invoice No:</b> <span id="inv">INV-001</span></p>
      <p><b>Date:</b> <span id="date"></span></p>
    </div>

    <table class="details">
      <tr><td><b>Received From</b></td><td id="namePreview"></td></tr>
      <tr><td><b>Payment Method</b></td><td id="payPreview"></td></tr>
      <tr><td><b>Description</b></td><td id="descPreview"></td></tr>
      <tr><td><b>Amount</b></td><td id="amountPreview"></td></tr>
    </table>

    <div class="footer">
      <p><b>Total (in words):</b> <span id="words"></span></p>
      <p style="text-align:right;margin-top:40px;"><b>Authorized Signatory</b></p>
    </div>
  </div>

  <!-- âœ… Main Script -->
  <script type="module">
    import { db, doc, getDoc, setDoc, updateDoc, storage, ref, uploadBytes } from "./index.html"; // Netlify will inline imports

    const el = id => document.getElementById(id);

    // --- Firestore invoice number functions ---
    async function getInvoiceCounter() {
      const refDoc = doc(db, "settings", "invoiceCounter");
      const snap = await getDoc(refDoc);
      if (!snap.exists()) {
        await setDoc(refDoc, { value: 1 });
        return 1;
      }
      return snap.data().value;
    }

    async function incrementInvoiceCounter() {
      const refDoc = doc(db, "settings", "invoiceCounter");
      const snap = await getDoc(refDoc);
      const current = snap.data().value || 1;
      const next = current + 1;
      await updateDoc(refDoc, { value: next });
      return next;
    }

    function numberToWords(num){
      num = parseInt(num,10);
      if(!num) return 'Zero only.';
      const a=["","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"];
      const b=["","","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"];
      function inHundreds(n){
        let str='';
        if(n>=100){str += a[Math.floor(n/100)]+' Hundred '; n%=100}
        if(n>=20){str += b[Math.floor(n/10)]+' '; if(n%10) str+=a[n%10]+' '}
        else if(n>0){str += a[n]+' '}
        return str.trim();
      }
      let out='';
      const thousand = Math.floor(num/1000);
      if(thousand){out+= inHundreds(thousand)+' Thousand '; num%=1000}
      if(num>0) out+= inHundreds(num);
      return out.trim() + ' only.';
    }

    // --- Update Preview ---
    async function updatePreview() {
      const invoiceCounter = await getInvoiceCounter();
      el("inv").textContent = "INV-" + String(invoiceCounter).padStart(3,"0");
      el("date").textContent = new Date().toLocaleDateString();
      el("namePreview").textContent = el("name").value;
      el("payPreview").textContent = el("payment").value;
      el("amountPreview").textContent = el("amount").value + "â‚¹";
      el("descPreview").textContent = el("description").value;
      el("words").textContent = numberToWords(el("amount").value);
    }

    el("previewBtn").addEventListener("click", updatePreview);

    el("printBtn").addEventListener("click", async () => {
      await updatePreview();

      const invoiceCounter = await getInvoiceCounter();
      const fileName = `INV-${String(invoiceCounter).padStart(3, "0")}.pdf`;

      // 1. Generate PDF
      const receiptElement = el("receiptPreview");
      const pdfBlob = await html2pdf().from(receiptElement).outputPdf("blob");

      // 2. Upload PDF to Firebase Storage
      const storageRef = ref(storage, "receipts/" + fileName);
      await uploadBytes(storageRef, pdfBlob);

      alert("âœ… Receipt saved to cloud as " + fileName);

      // 3. Print
      const w = window.open("", "_blank");
      w.document.write("<html><head><title>Receipt</title></head><body>" + receiptElement.outerHTML + "</body></html>");
      w.document.close();

      setTimeout(async () => {
        w.print();
        await incrementInvoiceCounter();
        await updatePreview();
      }, 500);
    });

    // Init preview
    updatePreview();
  </script>
</body>
</html>
